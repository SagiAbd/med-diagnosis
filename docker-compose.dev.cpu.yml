# docker compose -f docker-compose.dev.cpu.yml up -d --build

services:
    nginx-dev:
        image: nginx:alpine
        ports:
            - "80:80"
        volumes:
            - ./nginx.dev.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - frontend
            - backend
            - minio
        networks:
            - app_network
        healthcheck:
            test: [ "CMD", "nginx", "-t" ]
            interval: 30s
            timeout: 10s
            retries: 3
        restart: unless-stopped
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile.dev
        ports:
            - "8000:8000"
        env_file:
            - .env
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            - DEBUG=1
            - PYTHONUNBUFFERED=1
            - CORPUS_JSON_PATH=corpus/corpus.json
            - CORPUS_FULL_TEXT_PATH=corpus/corpus_full_text.jsonl
        volumes:
            - ./backend:/app
            - ./uploads:/app/uploads
            - ./chroma_data:/app/data/chroma
            - ./data:/app/corpus:ro
        networks:
            - app_network
        depends_on:
            - db
            - minio
            - tei
        restart: on-failure
        deploy:
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    tei:
        image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.8
        platform: linux/amd64
        container_name: tei
        env_file:
            - .env
        environment:
            MODEL_ID: ${TEI_EMBEDDINGS_MODEL:-google/embeddinggemma-300m}
            HF_TOKEN: ${HF_TOKEN}
        # Qwen embeddings specific configuration:
        # --max-batch-tokens: Prevents OOM errors during model warmup on limited memory devices
        # --pooling: Embedding aggregation strategy  
        # --auto-truncate: Automatically handles text longer than model's max length
        # command: ["--max-batch-tokens", "8192", "--pooling", "mean", "--auto-truncate"]
        ports:
            - "8080:80"
        networks:
            - app_network
        restart: on-failure
        deploy:
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.dev
        environment:
            - WATCHPACK_POLLING=true
            - CHOKIDAR_USEPOLLING=true
            - NODE_ENV=development
            - NEXT_PUBLIC_API_URL=http://localhost/api
        ports:
            - "3000:3000"
        volumes:
            - ./frontend:/app
            - /app/node_modules
        env_file:
            - .env
        networks:
            - app_network
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    db:
        image: mysql:8.0
        command: --default-authentication-plugin=mysql_native_password
        environment:
            - MYSQL_ROOT_PASSWORD=root
            - MYSQL_DATABASE=ragwebui
            - MYSQL_USER=ragwebui
            - MYSQL_PASSWORD=ragwebui
            - TZ=Asia/Shanghai
        ports:
            - "3306:3306"
        volumes:
            - mysql_data:/var/lib/mysql
        networks:
            - app_network

    minio:
        image: minio/minio:latest
        ports:
            - "9000:9000"
            - "9001:9001"
        environment:
            - MINIO_ROOT_USER=minioadmin
            - MINIO_ROOT_PASSWORD=minioadmin
        volumes:
            - minio_data:/data
        command: server --console-address ":9001" /data
        networks:
            - app_network

volumes:
    mysql_data:
    minio_data:
networks:
    app_network:
        driver: bridge
